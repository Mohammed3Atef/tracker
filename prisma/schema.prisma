// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum TimeSessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum BreakType {
  LUNCH
  REST
  MEAL
  OTHER
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum LeaveRequestType {
  VACATION
  SICK
  PERSONAL
  UNPAID
  MATERNITY
  PATERNITY
  OTHER
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollRunStatus {
  DRAFT
  PROCESSING
  COMPLETED
  FAILED
}

// Models
model User {
  id            String           @id @default(uuid())
  email         String           @unique
  password      String
  roleId        String
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  role          Role             @relation(fields: [roleId], references: [id], onDelete: Restrict)
  profile       EmployeeProfile?
  timeSessions  TimeSession[]
  shifts        Shift[]
  leaveRequests LeaveRequest[]
  payslips      Payslip[]
  auditLogs     AuditLog[]       @relation("AuditLogUser")
  createdAudits AuditLog[]       @relation("AuditLogCreatedBy")

  @@index([roleId])
  @@index([email])
}

model Role {
  id            String           @id @default(uuid())
  name          String           @unique
  description   String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  users         User[]
  permissions   RolePermission[]

  @@index([name])
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  roles       RolePermission[]

  @@index([resource, action])
  @@index([name])
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model EmployeeProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  employeeId    String   @unique
  firstName     String
  lastName      String
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?
  hireDate      DateTime
  department    String?
  position      String?
  salary        Decimal? @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([employeeId])
  @@index([department])
}

model TimeSession {
  id            String            @id @default(uuid())
  userId        String
  startTime     DateTime
  endTime       DateTime?
  duration      Int?              // Duration in minutes
  status        TimeSessionStatus @default(ACTIVE)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  breakSessions BreakSession[]

  @@index([userId])
  @@index([startTime])
  @@index([status])
  @@index([userId, startTime])
}

model BreakSession {
  id            String    @id @default(uuid())
  timeSessionId String
  startTime     DateTime
  endTime       DateTime?
  duration      Int?      // Duration in minutes
  type          BreakType @default(REST)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  timeSession   TimeSession @relation(fields: [timeSessionId], references: [id], onDelete: Cascade)

  @@index([timeSessionId])
  @@index([startTime])
}

model Shift {
  id            String      @id @default(uuid())
  userId        String
  startTime     DateTime
  endTime       DateTime
  date          DateTime    @db.Date
  status        ShiftStatus @default(SCHEDULED)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([status])
  @@index([userId, date])
}

model LeaveRequest {
  id              String             @id @default(uuid())
  userId          String
  startDate       DateTime           @db.Date
  endDate         DateTime           @db.Date
  type            LeaveRequestType
  status          LeaveRequestStatus @default(PENDING)
  reason          String?
  rejectionReason String?
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@index([userId, status])
}

model PayrollRun {
  id            String            @id @default(uuid())
  runDate       DateTime          @default(now())
  periodStart   DateTime          @db.Date
  periodEnd     DateTime          @db.Date
  status        PayrollRunStatus  @default(DRAFT)
  totalAmount   Decimal?          @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  payslips      Payslip[]

  @@index([runDate])
  @@index([status])
  @@index([periodStart, periodEnd])
}

model Payslip {
  id            String    @id @default(uuid())
  payrollRunId  String
  userId        String
  grossPay      Decimal   @db.Decimal(10, 2)
  deductions    Decimal   @db.Decimal(10, 2) @default(0)
  netPay        Decimal   @db.Decimal(10, 2)
  period        String
  payDate       DateTime  @db.Date
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  payrollRun    PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([payrollRunId])
  @@index([userId])
  @@index([payDate])
  @@index([payrollRunId, userId])
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  resource    String
  resourceId  String?
  userId      String?
  createdBy   String?
  metadata    Json?
  timestamp   DateTime @default(now())

  user        User?    @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)
  creator     User?    @relation("AuditLogCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([resource, resourceId])
  @@index([timestamp])
  @@index([action])
}
